
import requests
import pandas as pd
from sqlalchemy import create_engine, text

# ================================
# 1. CONFIGURA√á√ïES
# ================================

# API do Bubble
url_bubble = "https://meuapp.com.br/api/1.1/obj/XXXXXXXX"
key = "XXXXXXX"

BUBBLE_API_URL = {url_bubble}
PRIVATE_KEY = {key}
HEADERS = {
    "Authorization": f"Bearer {PRIVATE_KEY}",
    "Content-Type": "application/json"
}

# Conex√£o com o Azure SQL
usuario = "XXXXX"
senha ="XXXX"
servidor ="XXXX"
banco="XXXXX"
conn_url = (
    f"mssql+pyodbc://{usuario}:{senha}@{servidor}:1433/{banco}"
    "XXXXX"
)

# ================================
# 2. FUN√á√ÉO PARA BUSCAR TODOS OS DADOS DA API
# ================================

def get_all_bubble_data(api_url, headers):
    todos_dados = []
    cursor = 0
    pagina = 1

    while True:
        print(f"üì• Buscando p√°gina {pagina} (cursor={cursor})...")
        response = requests.get(f"{api_url}?cursor={cursor}", headers=headers)

        if response.status_code != 200:
            print(f"‚ùå Erro na requisi√ß√£o (status {response.status_code})")
            break

        resposta_json = response.json()
        resultados = resposta_json.get("response", {}).get("results", [])
        todos_dados.extend(resultados)

        if len(resultados) < 100:
            print("‚úÖ √öltima p√°gina alcan√ßada.")
            break

        cursor += 100
        pagina += 1

    return todos_dados

# ================================
# 3. CONECTAR AO BANCO DE DADOS
# ================================

print("üîó Conectando ao Azure SQL...")
try:
    engine = create_engine(conn_url)
    with engine.connect() as conn:
        result = conn.execute(text("SELECT GETDATE()"))
        for row in result:
            print("‚úÖ Conectado com sucesso! Data/hora no SQL:", row[0])
except Exception as e:
    print("‚ùå Falha na conex√£o com Azure:")
    print(e)
    exit()

# ================================
# 4. BUSCAR DADOS DA API BUBBLE
# ================================

print("\nüîÑ Buscando todos os dados da API Bubble com pagina√ß√£o...")
dados = get_all_bubble_data(BUBBLE_API_URL, HEADERS)
print(f"üì¶ Total de registros obtidos: {len(dados)}")

# ================================
# 5. TRANSFORMAR EM DATAFRAME E INSERIR NO SQL
# ================================

if dados:
    df = pd.DataFrame(dados)
    print("\nüìä Preview dos dados:")
    print(df.head())

    print("\nüîé Tipos de dados:")
    print(df.dtypes)

    try:
        df.to_sql("NomeTabela ", con=engine, if_exists="replace", index=False, schema='dbo')
        print("‚úÖ Todos os dados foram inseridos com sucesso no SQL!")
    except Exception as e:
        print("‚ùå Erro ao inserir os dados no SQL:")
        print(e)
else:
    print("‚ö†Ô∏è Nenhum dado retornado da API.")
